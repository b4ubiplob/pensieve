# ID Generation in UserService - Implementation Summary

## ‚úÖ Successfully Implemented

### Changes Made to UserService.java

**Location:** `src/main/java/com/tan90/projects/pensieve/service/UserService.java`

#### 1. Added UUID Import
```java
import java.util.UUID;
```

#### 2. Modified createUser() Method
Added automatic ID generation logic:

```java
public User createUser(User user) {
    if (userRepository.existsByEmail(user.getEmail())) {
        throw new IllegalArgumentException("User with email " + user.getEmail() + " already exists");
    }
    
    // Generate ID if not provided
    if (user.getId() == null || user.getId().isEmpty()) {
        user.setId(UUID.randomUUID().toString());
    }
    
    return userRepository.save(user);
}
```

---

## How It Works

### Flow Diagram
```
POST /users
    ‚Üì
UserController.createUser()
    ‚Üì
UserService.createUser()
    ‚Üì
Check if email exists ‚Üí If yes, throw exception
    ‚Üì
Check if ID is null or empty
    ‚Üì
If no ID ‚Üí Generate UUID.randomUUID().toString()
    ‚Üì
Set generated ID to user object
    ‚Üì
Save to database via UserRepository
    ‚Üì
Return created user with auto-generated ID
```

---

## Usage Examples

### Example 1: Create User WITHOUT ID (Auto-Generated)

**Request:**
```bash
curl -X POST http://localhost:8080/users \
  -H "Content-Type: application/json" \
  -d '{
    "email": "john@example.com",
    "password": "password123",
    "name": "John Doe"
  }'
```

**Response (201 Created):**
```json
{
  "id": "f47ac10b-58cc-4372-a567-0e02b2c3d479",  // ‚Üê Auto-generated by UserService
  "email": "john@example.com",
  "password": "password123",
  "name": "John Doe",
  "picture": null,
  "projects": []
}
```

---

### Example 2: Create User WITH Custom ID (Optional)

**Request:**
```bash
curl -X POST http://localhost:8080/users \
  -H "Content-Type: application/json" \
  -d '{
    "id": "my-custom-id-123",
    "email": "jane@example.com",
    "password": "password456",
    "name": "Jane Doe"
  }'
```

**Response (201 Created):**
```json
{
  "id": "my-custom-id-123",  // ‚Üê Uses your custom ID
  "email": "jane@example.com",
  "password": "password456",
  "name": "Jane Doe",
  "picture": null,
  "projects": []
}
```

---

### Example 3: Create User With Empty ID (Auto-Generated)

**Request:**
```bash
curl -X POST http://localhost:8080/users \
  -H "Content-Type: application/json" \
  -d '{
    "id": "",
    "email": "alice@example.com",
    "password": "password789",
    "name": "Alice Smith"
  }'
```

**Response (201 Created):**
```json
{
  "id": "8c3d5e2f-9a7b-4c1e-a5d2-3f6e8b9c1d4a",  // ‚Üê Empty ID replaced with UUID
  "email": "alice@example.com",
  "password": "password789",
  "name": "Alice Smith",
  "picture": null,
  "projects": []
}
```

---

## Technical Details

### ID Generation Logic
```java
if (user.getId() == null || user.getId().isEmpty()) {
    user.setId(UUID.randomUUID().toString());
}
```

**Conditions for Auto-Generation:**
- ‚úÖ ID is `null` (not provided in request)
- ‚úÖ ID is empty string `""`

**When Custom ID is Used:**
- ‚ùå ID is provided and not empty

### UUID Format
- **Type:** UUID Version 4 (Random)
- **Format:** `xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx`
- **Example:** `f47ac10b-58cc-4372-a567-0e02b2c3d479`
- **Length:** 36 characters (32 hex + 4 hyphens)
- **Storage:** Fits in VARCHAR(64) column

---

## Advantages of Service-Level ID Generation

### ‚úÖ Pros
1. **Business Logic Centralized** - ID generation is part of service layer
2. **Easy to Test** - Can be unit tested independently
3. **Flexible** - Can change generation strategy easily
4. **Explicit Control** - Clear when and how IDs are generated
5. **Validation Friendly** - Can add additional ID validation logic

### üìù Notes
- ID generation happens BEFORE database save
- No database round-trip needed
- Works with or without custom IDs
- Thread-safe (UUID.randomUUID() is thread-safe)

---

## Testing

### Unit Test Example (Recommended)
```java
@Test
public void testCreateUser_WithoutId_GeneratesUUID() {
    User user = new User();
    user.setEmail("test@example.com");
    user.setPassword("pass123");
    user.setName("Test User");
    // Note: No ID set
    
    User created = userService.createUser(user);
    
    assertNotNull(created.getId());
    assertTrue(created.getId().length() == 36); // UUID length
}

@Test
public void testCreateUser_WithCustomId_UsesCustomId() {
    User user = new User();
    user.setId("my-custom-id");
    user.setEmail("test@example.com");
    user.setPassword("pass123");
    user.setName("Test User");
    
    User created = userService.createUser(user);
    
    assertEquals("my-custom-id", created.getId());
}
```

---

## Complete Code Reference

### UserService.java (Updated)
```java
package com.tan90.projects.pensieve.service;

import com.tan90.projects.pensieve.entity.User;
import com.tan90.projects.pensieve.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Optional;
import java.util.UUID;  // ‚Üê Added

@Service
@Transactional
public class UserService {

    @Autowired
    private UserRepository userRepository;

    public User createUser(User user) {
        if (userRepository.existsByEmail(user.getEmail())) {
            throw new IllegalArgumentException("User with email " + user.getEmail() + " already exists");
        }
        
        // Generate ID if not provided  ‚Üê Added
        if (user.getId() == null || user.getId().isEmpty()) {
            user.setId(UUID.randomUUID().toString());
        }
        
        return userRepository.save(user);
    }
    
    // ... other methods unchanged
}
```

---

## Comparison: Entity vs Service Level ID Generation

| Aspect | @PrePersist (Entity) | Service Method |
|--------|---------------------|----------------|
| **Location** | User.java entity | UserService.java |
| **Trigger** | Before JPA persist | Before save call |
| **Visibility** | Automatic, hidden | Explicit in code |
| **Testing** | Harder to unit test | Easy to unit test |
| **Control** | JPA lifecycle | Service method |
| **Flexibility** | Limited | High |
| **Best For** | Simple cases | Complex logic |

**‚úÖ Current Implementation:** Service-level generation for better control and testability.

---

## Status

‚úÖ **Implementation Complete**  
‚úÖ **Compilation Successful**  
‚úÖ **No Errors**  
‚úÖ **Ready for Testing**  

### Next Steps
1. Start the application: `./mvnw spring-boot:run`
2. Test with cURL (see examples above)
3. Optional: Write unit tests for the service
4. Optional: Add validation for custom IDs

---

**Date:** December 25, 2025  
**File Modified:** `UserService.java`  
**Lines Changed:** 2 (import + ID generation logic)

